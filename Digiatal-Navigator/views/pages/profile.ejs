<%- include('../partials/header', { title: '–ü—Ä–æ—Ñ–∏–ª—å', page: 'profile' }) %>

  <main>
    <section class="page-header">
      <div class="container">
        <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
        <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ</p>
      </div>
    </section>

    <section class="profile-section">
      <div class="container">
        <div class="profile-container">
          <div class="profile-card">
            <div class="profile-header">
              <div class="profile-avatar">
                <% if (typeof user !== 'undefined' && user && user.avatar_path) { %>
                  <img src="<%= user.avatar_path %>" alt="Avatar" class="profile-avatar-image">
                <% } else { %>
                  <%= typeof user !== 'undefined' && user ? user.username.charAt(0).toUpperCase() : 'U' %>
                <% } %>
              </div>
              <h2><%= typeof user !== 'undefined' && user ? user.username : '' %></h2>
              <span class="role-badge-large role-<%= typeof user !== 'undefined' && user ? user.role : 'user' %>">
                <%= typeof user !== 'undefined' && user ? user.role : 'user' %>
              </span>
            </div>

            <% if (typeof query !== 'undefined' && query.success === 'updated') { %>
              <div class="success-message">
                <p>‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!</p>
              </div>
            <% } %>

            <div class="profile-info">
              <div class="info-item">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <span><%= typeof user !== 'undefined' && user ? user.username : '' %></span>
              </div>

              <div class="info-item">
                <label>Email:</label>
                <span><%= typeof user !== 'undefined' && user ? user.email : '' %></span>
              </div>

              <% if (typeof user !== 'undefined' && user && (user.first_name || user.last_name)) { %>
                <div class="info-item">
                  <label>–ò–º—è:</label>
                  <span><%= user.first_name || '' %> <%= user.last_name || '' %></span>
                </div>
              <% } %>

              <% if (typeof user !== 'undefined' && user && user.phone) { %>
                <div class="info-item">
                  <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                  <span><%= user.phone %></span>
                </div>
              <% } %>
              
              <div class="info-item">
                <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <span><%= typeof user !== 'undefined' && user ? user.id : '' %></span>
              </div>

              <div class="info-item">
                <label>–†–æ–ª—å:</label>
                <span class="role-name"><%= typeof user !== 'undefined' && user ? user.role : 'user' %></span>
                <% if (typeof user !== 'undefined' && user && user.role === 'superadmin') { %>
                  <p class="role-description">–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º —Å–∏—Å—Ç–µ–º—ã</p>
                <% } else if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
                  <p class="role-description">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä - –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏</p>
                <% } else { %>
                  <p class="role-description">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –±–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–∞–π—Ç—É</p>
                <% } %>
              </div>

              <% if (typeof user !== 'undefined' && user && user.created_at) { %>
                <div class="info-item">
                  <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
                  <span><%= new Date(user.created_at).toLocaleDateString('ru-RU') %></span>
                </div>
              <% } %>
            </div>

            <!-- –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
            <% if (typeof registrations !== 'undefined' && registrations && registrations.length > 0) { %>
              <div class="profile-registrations" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
                <div class="registrations-list">
                  <% registrations.forEach(function(registration) { %>
                    <% 
                      const eventDate = new Date(registration.event_date);
                      const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                                     '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                      const day = eventDate.getDate();
                      const month = months[eventDate.getMonth()];
                      const year = eventDate.getFullYear();
                      const formattedDate = eventDate.toLocaleDateString('ru-RU', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric' 
                      });
                    %>
                    <div class="registration-item" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border-color);">
                      <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                          <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color);"><%= registration.title %></h4>
                          <% if (registration.description) { %>
                            <p style="margin: 0 0 0.5rem 0; color: var(--text-light);"><%= registration.description %></p>
                          <% } %>
                          <div style="display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.9rem; color: var(--text-light);">
                            <span>üìÖ <%= formattedDate %></span>
                            <% if (registration.event_time) { %>
                              <span>‚è∞ <%= registration.event_time %></span>
                            <% } %>
                            <% if (registration.location) { %>
                              <span>üìç <%= registration.location %></span>
                            <% } %>
                          </div>
                        </div>
                        <div>
                          <a href="/participation" class="btn btn-secondary btn-small">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                        </div>
                      </div>
                    </div>
                  <% }); %>
                </div>
              </div>
            <% } else if (typeof registrations !== 'undefined') { %>
              <div class="profile-registrations" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
                <p style="color: var(--text-light); margin-bottom: 1rem;">–í—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∏ –Ω–∞ –æ–¥–Ω–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.</p>
                <div style="text-align: center;">
                  <a href="/participation" class="btn btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
                </div>
              </div>
            <% } %>

            <div class="profile-actions">
              <a href="/profile/edit" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
              <a href="/profile/password" class="btn btn-secondary">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a>
              <% if (typeof user !== 'undefined' && user && (user.role === 'admin' || user.role === 'superadmin')) { %>
                <a href="/admin" class="btn btn-secondary">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
              <% } %>
              <form action="/logout" method="POST" class="logout-form-inline">
                <button type="submit" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

<%- include('../partials/footer') %>
