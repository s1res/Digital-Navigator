<%- include('../partials/header', { title: '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å', page: 'admin-feedback' }) %>

  <main>
    <section class="page-header">
      <div class="container">
        <h1>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h1>
        <p>–°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã ¬´–ö–æ–Ω—Ç–∞–∫—Ç—ã¬ª</p>
      </div>
    </section>

    <section class="admin-section">
      <div class="container">
        <% if (typeof query !== 'undefined' && query.success === 'replied') { %>
          <div class="success-message">
            <p>‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ</p>
          </div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.success === 'deleted') { %>
          <div class="success-message">
            <p>‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</p>
          </div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.success === 'updated') { %>
          <div class="success-message">
            <p>‚úÖ –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω</p>
          </div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.error) { %>
          <div class="error-message">
            <p>‚ùå –û—à–∏–±–∫–∞: <%= query.error === 'reply_failed' ? '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç' : query.error === 'delete_failed' ? '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è' %></p>
          </div>
        <% } %>

        <div style="margin-bottom: 2rem; text-align: right;">
          <a href="/admin" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
        </div>

        <div class="events-management-table">
          <% if (typeof feedback !== 'undefined' && feedback && feedback.length > 0) { %>
            <table>
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ò–º—è</th>
                  <th>Email</th>
                  <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                  <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                  <th>–û—Ç–≤–µ—Ç–æ–≤</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                <% feedback.forEach(function(item) { %>
                  <% 
                    const createdDate = new Date(item.created_at);
                    const formattedDate = createdDate.toLocaleDateString('ru-RU', { 
                      day: 'numeric', 
                      month: 'long', 
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    });
                    const repliesCount = item.replies ? item.replies.length : 0;
                  %>
                  <tr data-feedback-id="<%= item.id %>">
                    <td><strong><%= formattedDate %></strong></td>
                    <td><%= item.name %></td>
                    <td><%= item.email %></td>
                    <td><%= item.phone || '-' %></td>
                    <td>
                      <div class="message-preview">
                        <%= item.message.length > 100 ? item.message.substring(0, 100) + '...' : item.message %>
                      </div>
                    </td>
                    <td>
                      <% if (repliesCount > 0) { %>
                        <span class="replies-badge"><%= repliesCount %></span>
                      <% } else { %>
                        <span>-</span>
                      <% } %>
                    </td>
                    <td>
                      <span class="feedback-status <%= item.status === 'processed' ? 'status-processed' : 'status-new' %>">
                        <%= item.status === 'processed' ? '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ' : '–ù–æ–≤–æ–µ' %>
                      </span>
                    </td>
                    <td>
                      <div class="dropdown">
                        <button class="dropdown-toggle btn btn-secondary btn-small" type="button" onclick="toggleDropdown(<%= item.id %>)">
                          –î–µ–π—Å—Ç–≤–∏—è ‚ñº
                        </button>
                        <div class="dropdown-menu" id="dropdown-<%= item.id %>">
                          <button type="button" class="dropdown-item" onclick="showReplyForm(<%= item.id %>, '<%= item.name %>', '<%= item.email %>')">
                            üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å
                          </button>
                          <% if (item.status !== 'processed') { %>
                            <form action="/admin/feedback/<%= item.id %>/status" method="POST" style="margin: 0;">
                              <input type="hidden" name="status" value="processed">
                              <button type="submit" class="dropdown-item">
                                ‚úì –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
                              </button>
                            </form>
                          <% } %>
                          <form action="/admin/feedback/<%= item.id %>/delete" method="POST" style="margin: 0;" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?');">
                            <button type="submit" class="dropdown-item danger">
                              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                          </form>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ -->
                  <div class="modal" id="modal-<%= item.id %>" style="display: none;">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h3>–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
                        <button type="button" class="modal-close" onclick="closeModal(<%= item.id %>)">&times;</button>
                      </div>
                      <div class="modal-body">
                        <div class="message-details">
                          <p><strong>–û—Ç:</strong> <%= item.name %> (<%= item.email %>)</p>
                          <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong></p>
                          <div class="message-text"><%= item.message %></div>
                        </div>
                        <% if (item.replies && item.replies.length > 0) { %>
                          <div class="existing-replies">
                            <h4>–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã:</h4>
                            <% item.replies.forEach(function(reply) { %>
                              <% 
                                const replyDate = new Date(reply.created_at);
                                const formattedReplyDate = replyDate.toLocaleDateString('ru-RU', { 
                                  day: 'numeric', 
                                  month: 'long', 
                                  year: 'numeric',
                                  hour: '2-digit',
                                  minute: '2-digit'
                                });
                              %>
                              <div class="reply-item">
                                <div class="reply-header">
                                  <strong><%= reply.username || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' %></strong>
                                  <span class="reply-date"><%= formattedReplyDate %></span>
                                </div>
                                <div class="reply-text">
                                  <p><%= reply.reply_text %></p>
                                </div>
                              </div>
                            <% }); %>
                          </div>
                        <% } %>
                        <form action="/admin/feedback/<%= item.id %>/reply" method="POST" class="reply-form">
                          <div class="form-group">
                            <label for="reply_<%= item.id %>">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                            <textarea 
                              id="reply_<%= item.id %>" 
                              name="reply_text" 
                              rows="5" 
                              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
                              required></textarea>
                          </div>
                          <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeModal(<%= item.id %>)">–û—Ç–º–µ–Ω–∞</button>
                            <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </tbody>
            </table>
          <% } else { %>
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
              <p>–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
            </div>
          <% } %>
        </div>
      </div>
    </section>
  </main>

  <script>
    function toggleDropdown(id) {
      const dropdown = document.getElementById('dropdown-' + id);
      const isOpen = dropdown.style.display === 'block';
      
      // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –¥—Ä—É–≥–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
      });
      
      // –û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ–Ω—é
      dropdown.style.display = isOpen ? 'none' : 'block';
    }

    function showReplyForm(id, name, email) {
      closeAllDropdowns();
      const modal = document.getElementById('modal-' + id);
      modal.style.display = 'flex';
    }

    function closeModal(id) {
      const modal = document.getElementById('modal-' + id);
      modal.style.display = 'none';
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
      });
    }

    // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.dropdown')) {
        closeAllDropdowns();
      }
    });

    // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    });
  </script>

<%- include('../partials/footer') %>
